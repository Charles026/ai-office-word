# DocOps Runtime v1 重构笔记

## 1. 概述

本文档记录了 DocOps Runtime v1 重构的完成状态和自测清单。

**目标**：将编辑主链路从「直接操作 Lexical」迁移到「CommandBus → DocOps → DocumentEngine → AST → Reconciler → Lexical」。

**当前状态**：v1 基础功能已完成，通过 Feature Flag 控制，默认关闭。

---

## 2. 如何启用新路径

在浏览器 DevTools 控制台中执行：

```javascript
// 启用所有新路径
__commandFeatureFlags.set({
  useCommandBusForFormat: true,      // 文本格式：bold/italic/underline/strikethrough
  useCommandBusForBlockType: true,   // 块级格式：paragraph/heading1/2/3
  useCommandBusForHistory: true,     // 历史：undo/redo
  useCommandBusForEdit: true,        // 编辑：insertText（谨慎）
});

// 查看当前状态
__commandFeatureFlags.get();

// 重置为默认（全部关闭）
__commandFeatureFlags.reset();
```

---

## 3. 自测 Checklist

### 3.1 基础格式命令

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 选中一个词，点击 **B** 加粗 | 只有选中的词变粗，其他文字不变 | ☐ |
| 选中一个词，点击 **I** 斜体 | 只有选中的词变斜体 | ☐ |
| 选中一个词，点击 **U** 下划线 | 只有选中的词加下划线 | ☐ |
| 选中一个词，点击 **S** 删除线 | 只有选中的词加删除线 | ☐ |
| 对已加粗的词再次点击 **B** | 加粗被取消 | ☐ |

### 3.2 多格式叠加

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 选中词 A 加粗，选中词 B 斜体 | 两个词各自保持格式，互不影响 | ☐ |
| 选中已斜体的词，再加粗 | 该词同时有斜体和粗体 | ☐ |
| 在 H2 标题中选中一个词加粗 | 标题级别不变，词变粗 | ☐ |

### 3.3 跨段落操作

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 在段落 1 加粗词 A，在段落 2 加粗词 B | 两个词都保持加粗，互不影响 | ☐ |
| 在段落 1 加粗，切换到段落 2 加粗 | 段落 1 的加粗不会被取消 | ☐ |

### 3.4 块级格式

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 光标在段落中，点击 H1 | 段落变成 H1 标题 | ☐ |
| 光标在 H1 中，点击 H2 | 标题级别变为 H2 | ☐ |
| 光标在 H2 中，点击「正文」 | 标题变回普通段落 | ☐ |
| 段落中有加粗词，改为 H1 | 加粗格式保留 | ☐ |

### 3.5 Undo/Redo

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 加粗一个词，按 Cmd+Z | 加粗被撤销 | ☐ |
| 撤销后，按 Cmd+Shift+Z | 加粗恢复 | ☐ |
| 连续操作多次，多次撤销 | 按操作顺序逐个撤销 | ☐ |
| 撤销后编辑新内容 | redo 栈被清空 | ☐ |

### 3.6 空文档场景

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 新建空文档，直接点击 **B** | 不崩溃，后续输入的文字带粗体 | ☐ |
| 新建空文档，输入几个字，选中加粗 | 正常工作 | ☐ |
| 新建空文档，按 Cmd+Z | 不崩溃（可能无操作） | ☐ |

### 3.7 边界情况

| 测试场景 | 预期结果 | 通过 |
|---------|---------|------|
| 选中整个段落加粗 | 整段变粗 | ☐ |
| 光标在词中间（无选区），点击 **B** | 不崩溃，可能影响后续输入或无操作 | ☐ |
| 快速连续点击 **B** 多次 | 格式正确切换，不崩溃 | ☐ |

---

## 4. 已知问题和限制

### 4.1 当前限制

1. **列表支持**：尚未支持 bullet/number list 的 DocOps 路径
2. **IME 输入**：中文输入法场景未充分测试
3. **粘贴**：粘贴操作仍走 Lexical 原生路径
4. **性能**：Reconciler 采用全量重建，大文档可能有性能问题

### 4.2 回退机制

如果新路径失败，会自动 fallback 到 Lexical 原生路径：
```
[LexicalAdapter] CommandBus path failed for "xxx", falling back to legacy path
```

---

## 5. Bug 修复历史

### 5.1 toggleBold 整段加粗问题
- **问题**：选中一个词加粗，整段都变粗
- **原因**：`handleToggleBold` 忽略了 `startOffset`/`endOffset`
- **修复**：重写 `applyInlineMark` 方法，按选区范围精确切换

### 5.2 格式被"清洗"问题
- **问题**：toggleBold 后所有格式消失
- **原因**：`LexicalReconciler` 用 `getInlineText()` 合并文本，丢失 marks
- **修复**：`appendInlineNodesToLexical` 为每个 TextRunNode 创建独立 TextNode

### 5.3 Lexical → AST 丢失 marks
- **问题**：即使 Reconciler 正确，格式仍被清空
- **原因**：`lexicalNodeToBlock` 只取 `textContent`，丢失 marks
- **修复**：`extractInlineNodesFromLexical` + `extractMarksFromLexicalTextNode`

### 5.4 空文档崩溃
- **问题**：新建空文档后触发格式命令崩溃
- **原因**：桥接层未处理空文档/非 ElementNode 场景
- **修复**：添加 `$isElementNode` 检查 + 空文档默认段落

---

## 6. 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Ribbon    │  │   Editor    │  │  Shortcuts  │          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                    LexicalAdapter                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  shouldUseCommandBus(commandId) ?                   │    │
│  │    → executeCommandViaCommandBus()                  │    │
│  │    → fallback to Lexical native                     │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
          │
          ▼ (新路径)
┌─────────────────────────────────────────────────────────────┐
│                    CommandBus                                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1. syncLexicalToRuntime() - 同步 Lexical → AST     │    │
│  │  2. executeWithRuntime() - 生成 DocOps              │    │
│  │  3. reconcileAstToLexical() - 同步 AST → Lexical    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                  DocumentEngine                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  applyOps(ast, ops) → { nextAst, changed }          │    │
│  │  undo() / redo()                                     │    │
│  │  历史栈管理                                          │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                  DocumentRuntime                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  AST + Selection + Version                          │    │
│  │  getSnapshot() / setSelection() / subscribe()       │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 下一步计划

1. **性能优化**：实现增量 Reconciler，只更新变化的节点
2. **更多命令**：支持列表、缩进、对齐等块级操作
3. **IME 支持**：处理中文输入法的组合输入
4. **移除依赖**：当新路径稳定后，移除 Lexical HistoryPlugin

---

*最后更新：2025-11*

